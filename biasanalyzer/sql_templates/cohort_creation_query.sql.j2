{% extends "base.sql.j2" %}
{% block domain_events %}
{% if ranked_domains %}
WITH
{% for event_type, domain in ranked_domains.items() %}
{% if domain.table %}
ranked_asc_{{ event_type }} AS (
    SELECT
        person_id,
        {{ domain.concept_id }} AS concept_id,
        {{ domain.start_date }} AS event_start_date,
        {{ domain.end_date }} AS event_end_date,
        ROW_NUMBER() OVER (
            PARTITION BY person_id, {{ domain.concept_id }}
            ORDER BY {{ domain.start_date }} ASC
        ) AS event_instance
    FROM {{ domain.table }}
),
ranked_desc_{{ event_type }} AS (
    SELECT
        person_id,
        {{ domain.concept_id }} AS concept_id,
        {{ domain.start_date }} AS event_start_date,
        {{ domain.end_date }} AS event_end_date,
        ROW_NUMBER() OVER (
            PARTITION BY person_id, {{ domain.concept_id }}
            ORDER BY {{ domain.start_date }} DESC
        ) AS event_instance
    FROM {{ domain.table }}
),
{% endif %}
{% endfor %}
{% endblock %}

{% block inclusion_temporal_event_criteria %}
{% if inclusion_criteria.temporal_events %}
    {{ temporal_event_filter(inclusion_criteria.temporal_events) }}
{% else %}
    SELECT person_id, NULL AS event_start_date, NULL AS event_end_date, NULL AS adjusted_start, NULL AS adjusted_end
    FROM person p
{% endif %}
{% endblock %}

{% block inclusion_demographics_criteria %}
{% if inclusion_criteria.demographics %}
    {{ demographics_filter(inclusion_criteria.demographics) }}
{% endif %}
{% endblock %}

{% block exclusion_criteria %}
{% if exclusion_criteria %}
    {% if exclusion_criteria.demographics %}
        {{ demographics_filter(exclusion_criteria.demographics) }}
    {% endif %}
    {% if exclusion_criteria.temporal_events %}
        {{ temporal_event_filter(exclusion_criteria.temporal_events, alias="ex") }}
    {% endif %}
{% endif %}
{% endblock %}
